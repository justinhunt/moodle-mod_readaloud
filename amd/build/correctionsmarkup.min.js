define("mod_readaloud/correctionsmarkup",["jquery","core/log"],(function($,log){return log.debug("Corrections Markup: initialising"),{controls:{},cd:{insertclass:"mod_readaloud_finediffinsertion",passagewordclass:"mod_readaloud_mu_passage_word",passagespaceclass:"mod_readaloud_mu_passage_space",wordclass:"mod_readaloud_mu_corrections_word",spaceclass:"mod_readaloud_mu_corrections_space",originalprewordclass:"mod_readaloud_mu_original_preword",originalpostwordclass:"mod_readaloud_mu_original_postword",suggestionclass:"mod_readaloud_corrections_suggestedword",insertionclass:"mod_readaloud_corrections_insertionword",wordomittedclass:"mod_readaloud_corrections_omittedword",aiunmatched:"mod_readaloud_aiunmatched",aicorrected:"mod_readaloud_aicorrected",aiomitted:"mod_readaloud_aiomitted",aiinserted:"mod_readaloud_aiinserted",aisuggested:"mod_readaloud_aisuggested"},options:{errorwords:{},grammarmatches:{},suggestedwords:{},insertioncount:0},init:function(config){var theid="#"+config.id,configcontrol=$(theid).get(0);if(configcontrol){var opts=JSON.parse(configcontrol.value);log.debug(opts),$(theid).remove(),""!==opts.sessionerrors?this.options.suggestedwords=JSON.parse(opts.sessionerrors):this.options.suggestedwords={},""!==opts.sessionmatches?this.options.grammarmatches=JSON.parse(opts.sessionmatches):this.options.grammarmatches={},""!==opts.insertioncount?this.options.insertioncount=opts.insertioncount:this.options.insertioncount=0}else{if(!(config.hasOwnProperty("grammarerrors")&&config.hasOwnProperty("grammarmatches")&&config.hasOwnProperty("insertioncount")&&config.hasOwnProperty("correctionscontainer")))return void log.debug("Corrections Markup js: No config found on page. Giving up.");this.controls.correctionscontainer=config.correctionscontainer,this.options.suggestedwords=JSON.parse(config.grammarerrors),this.options.grammarmatches=JSON.parse(config.grammarmatches),this.options.insertioncount=config.insertioncount}log.debug(this.options),this.markup_suggestedwords(),this.markup_unmatchedwords(),this.markup_originalwords(),this.register_events()},register_events:function(){var that=this,highlightclasses="."+this.cd.wordclass+",."+this.cd.spaceclass+",."+this.cd.originalprewordclass+",."+this.cd.originalpostwordclass;this.controls.correctionscontainer.on("click",highlightclasses,(function(){var tpositions=$(this).attr("data-tpositions");if(log.debug(tpositions),void 0!==tpositions&&""!==tpositions){var correctiontype="";$(this).hasClass(that.cd.suggestionclass)&&(correctiontype="suggestion"),$(this).hasClass(that.cd.insertionclass)&&(correctiontype="insertion"),$(this).hasClass(that.cd.wordomittedclass)&&(correctiontype="omission"),that.highlightoriginal(tpositions,correctiontype),setTimeout((function(){that.dehighlightoriginal(tpositions)}),1e3)}})),this.controls.correctionscontainer.on("mouseover",highlightclasses,(function(){var tpositions=$(this).attr("data-tpositions");if(void 0!==tpositions&&""!==tpositions){var correctiontype="";$(this).hasClass(that.cd.suggestionclass)&&(correctiontype="suggestion"),$(this).hasClass(that.cd.insertionclass)&&(correctiontype="insertion"),$(this).hasClass(that.cd.wordomittedclass)&&(correctiontype="omission"),that.highlightoriginal(tpositions,correctiontype)}})),this.controls.correctionscontainer.on("mouseout",highlightclasses,(function(){var tpositions=$(this).attr("data-tpositions");void 0!==tpositions&&""!==tpositions&&that.dehighlightoriginal(tpositions)}))},highlightoriginal:function(tpositionstring,correctiontype){var tpositions=tpositionstring.split(","),correctionsclasses=[];correctionsclasses.push(this.cd.aicorrected),"insertion"===correctiontype?correctionsclasses.push(this.cd.aiinserted):"omission"===correctiontype?correctionsclasses.push(this.cd.aiomitted):"suggestion"===correctiontype&&correctionsclasses.push(this.cd.aisuggested);for(var i=0;i<tpositions.length;i++){var tposition=tpositions[i];"insertion"===correctiontype?$("#"+this.cd.passagespaceclass+"_"+tposition).addClass(correctionsclasses):($("#"+this.cd.passagewordclass+"_"+tposition).addClass(correctionsclasses),i<tpositions.length-1&&$("#"+this.cd.passagespaceclass+"_"+tposition).addClass(correctionsclasses))}},dehighlightoriginal:function(tpositionstring){var that=this,correctionsclasses=[that.cd.aicorrected,that.cd.aiinserted,that.cd.aiomitted,that.cd.aisuggested],tpositions=tpositionstring.split(",");$.each(tpositions,(function(index,tposition){$("#"+that.cd.passagewordclass+"_"+tposition).removeClass(correctionsclasses),$("#"+that.cd.passagespaceclass+"_"+tposition).removeClass(correctionsclasses)}))},markup_suggestedwords:function(){var m=this;if($.each(m.options.suggestedwords,(function(index){m.controls.correctionscontainer.find(" #"+m.cd.wordclass+"_"+m.options.suggestedwords[index].wordnumber).addClass(m.cd.suggestionclass)})),Object.keys(m.options.grammarmatches).length>0){var lastpposition=0,lasttposition=0;$.each(m.options.grammarmatches,(function(index,lastmatch){lastpposition=Number(lastmatch.pposition),lasttposition=Number(lastmatch.tposition)}));for(var lastwordnumber=Number(lastpposition),tpositions=[],i=lasttposition+1;i<=lasttposition+m.options.insertioncount+1;i++)tpositions.push(i);m.controls.correctionscontainer.find("."+m.cd.wordclass).filter((function(){return Number($(this).data("wordnumber"))>lastwordnumber&&!$(this).hasClass(m.cd.suggestionclass)})).addClass(m.cd.suggestionclass).attr("data-tpositions",tpositions.join(","))}},markup_unmatchedwords:function(){var that=this;if(this.options.grammarmatches){var prevmatch={tposition:0,pposition:0};$.each(this.options.grammarmatches,(function(index,match){if(match.tposition-prevmatch.tposition>1){var missingwordspacenumber=match.pposition-1;if(missingwordspacenumber>0){$("#"+that.cd.wordclass+"_"+match.pposition).hasClass(that.cd.suggestionclass)||$("#"+that.cd.wordclass+"_"+missingwordspacenumber).hasClass(that.cd.suggestionclass)||$("#"+that.cd.spaceclass+"_"+missingwordspacenumber).addClass(that.cd.wordomittedclass);for(var tpositions=[],i=prevmatch.tposition+1;i<match.tposition;i++)tpositions.push(i);if(0===match.pposition-prevmatch.pposition-1)$("#"+that.cd.spaceclass+"_"+missingwordspacenumber).attr("data-tpositions",tpositions.join(","));else for(var z=prevmatch.pposition+1;z<match.pposition;z++)$("#"+that.cd.spaceclass+"_"+z).attr("data-tpositions",tpositions.join(",")),$("#"+that.cd.wordclass+"_"+z).attr("data-tpositions",tpositions.join(","))}}else if(match.pposition-prevmatch.pposition>1)for(var insertedword=prevmatch.pposition+1;insertedword<match.pposition;insertedword++)$("#"+that.cd.wordclass+"_"+insertedword).addClass(that.cd.insertionclass),$("#"+that.cd.wordclass+"_"+insertedword).attr("data-tpositions",prevmatch.tposition);$("#"+that.cd.wordclass+"_"+match.pposition).attr("data-tpositions",match.tposition),prevmatch=match}))}},markup_originalwords:function(){var that=this,processed_tpositions=[];that.controls.correctionscontainer.find("."+that.cd.wordclass+", ."+that.cd.spaceclass).each((function(){var wordnumber=Number($(this).data("wordnumber"));if($(this).hasClass(that.cd.suggestionclass)||$(this).hasClass(that.cd.wordomittedclass)){var data_tpositions=$(this).attr("data-tpositions");if(processed_tpositions.includes(data_tpositions))return;processed_tpositions.push(data_tpositions);for(var tpositions=data_tpositions.split(","),originalwords=[],i=0;i<tpositions.length;i++){var tposition=tpositions[i];originalwords.push($("#"+that.cd.passagewordclass+"_"+tposition).text())}if(originalwords.length>0){var originaltext=originalwords.join(" ")+"->";$(this).hasClass(that.cd.suggestionclass)&&$(this).hasClass(that.cd.insertionclass)?($("#"+that.cd.originalprewordclass+"_"+wordnumber).text("_->"),$("#"+that.cd.originalprewordclass+"_"+wordnumber).attr("data-tpositions","")):$(this).hasClass(that.cd.suggestionclass)?($("#"+that.cd.originalprewordclass+"_"+wordnumber).text(originaltext),$("#"+that.cd.originalprewordclass+"_"+wordnumber).attr("data-tpositions",data_tpositions)):$(this).hasClass(that.cd.wordomittedclass)&&($("#"+that.cd.originalpostwordclass+"_"+wordnumber).text(" "+originaltext),$("#"+that.cd.originalpostwordclass+"_"+wordnumber).attr("data-tpositions",data_tpositions))}}}))}}}));

//# sourceMappingURL=correctionsmarkup.min.js.map