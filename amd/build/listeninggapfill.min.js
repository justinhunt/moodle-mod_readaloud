define("mod_readaloud/listeninggapfill",["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/pollyhelper","mod_readaloud/animatecss","mod_readaloud/progresstimer","core/templates"],(function($,log,ajax,def,polly,anim,progresstimer,templates){return log.debug("Readaloud listening gap fill: initialising"),{clone:function(){return $.extend(!0,{},this)},usevoice:"Amy",init:function(index,itemdata,quizhelper){this.itemdata=itemdata,this.quizhelper=quizhelper,this.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_events(),this.setvoice(),this.getItems()},next_question:function(){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=$("#"+this.itemdata.uniqueid+"_container .lgapfill_listen_cont"),qbox=$("#"+this.itemdata.uniqueid+"_container .question"),gamebox=$("#"+this.itemdata.uniqueid+"_container .lgapfill_game"),controlsbox=$("#"+this.itemdata.uniqueid+"_container .lgapfill_controls"),resultsbox=$("#"+this.itemdata.uniqueid+"_container .lgapfill_resultscontainer");templates.render("mod_readaloud/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;$("#"+self.itemdata.uniqueid+"_container .readaloud_nextbutton").on("click",(function(e){self.next_question()})),$("#"+self.itemdata.uniqueid+"_container .lgapfill_start_btn").on("click",(function(){self.start()}));var audioplayerbtn=$("#"+self.itemdata.uniqueid+"_container .lgapfill_listen_btn");audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),$("#"+self.itemdata.uniqueid+"_container").on("keydown",".single-character",(function(e){32==e.which&&(e.preventDefault(),audioplayerbtn.trigger("click"))})),$("#"+self.itemdata.uniqueid+"_container .lgapfill_skip_btn").on("click",(function(){$("#"+self.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .lgapfill_speech.lgapfill_teacher_left").text(self.items[self.game.pointer].prompt+""),$("#"+self.itemdata.uniqueid+"_container .lgapfill_targetWord").each((function(){var realidx=$(this).data("realidx"),lgapfill_targetWord=self.items[self.game.pointer].lgapfill_targetWords[realidx];$(this).val(lgapfill_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?setTimeout((function(){$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()})),$("#"+self.itemdata.uniqueid+"_container .lgapfill_check_btn").on("click",(function(){self.check_answer()})),$("#"+self.itemdata.uniqueid+"_container").on("keydown",".single-character",(function(e){13==e.which&&self.check_answer()})),$("#"+self.itemdata.uniqueid+"_container").on("keyup",".lgapfill_targetWord",(function(e){var target=e.srcElement||e.target,maxLength=parseInt(target.attributes.maxlength.value,10),myLength=target.value.length,key=e.which;if(myLength>=maxLength){var nextIdx=$(this).data("idx")+1,next=$("#"+self.itemdata.uniqueid+'_container input.lgapfill_targetWord[data-idx="'+nextIdx+'"');1===next.length&&next.focus()}else if((8==key||46==key)&&0===myLength){var previousIdx=$(this).data("idx")-1,previous=$("#"+self.itemdata.uniqueid+'_container input.lgapfill_targetWord[data-idx="'+previousIdx+'"');1===previous.length&&previous.focus()}}))},game:{pointer:0},check_answer:function(){var self=this,passage=self.items[self.game.pointer].parsedstring,characterunputs=$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" input.single-character"),transcript=[];characterunputs.each((function(){var index=$(this).data("index"),value=$(this).val();transcript.push={index:index,value:value}})),self.getComparison(passage,transcript,(function(comparison){self.gotComparison(comparison)}))},setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,definition:target.definition,typed:"",timer:[],answered:!1,correct:!1,audio:null}})).filter((function(e){return""!==e.target})),$.each(self.items,(function(index,item){polly.fetch_polly_url(item.prompt,self.voiceoption,self.usevoice).then((function(audiourl){item.audio=new Audio,item.audio.src=audiourl,0==self.items.filter((function(e){return null==e.audio})).length&&self.appReady()}))}))},appReady:function(){$("#"+this.itemdata.uniqueid+"_container .lgapfill_not_loaded").hide(),$("#"+this.itemdata.uniqueid+"_container .lgapfill_loaded").show(),this.itemdata.hidestartpage?this.start():$("#"+this.itemdata.uniqueid+"_container .lgapfill_start_btn").prop("disabled",!1)},gotComparison:function(comparison){var self=this;log.debug("gotComparison",comparison);var timelimit_progressbar=$("#"+self.itemdata.uniqueid+"_container .progress-container .progress-bar");if(comparison)$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" .lgapfill_feedback[data-idx='"+self.game.pointer+"']").addClass("fa fa-check"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=!1,log.debug("correct!!"),$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" input").addClass("ra_gapfill_char_correct");else{if(self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete")){var thereply=$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer);return void anim.do_animate(thereply,"shakeX animate__faster").then((function(){$("#"+self.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!1)}))}$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" .lgapfill_feedback[data-idx='"+self.game.pointer+"']").addClass("fa fa-times"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.items[self.game.pointer].typed=!1}self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1?setTimeout((function(){$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()},getWords:function(thetext){for(var chunks=thetext.split(this.quizhelper.spliton_regexp).filter((function(e){return""!==e})),words=[],i=0;i<chunks.length;i++)chunks[i].match(this.quizhelper.spliton_regexp)||words.push(chunks[i]);return words},getComparison:function(passage,transcript,callback){var self=this;$("#"+self.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!0);var correctanswer=!0;passage.forEach((function(data,index){var char="";"input"===data.type&&!0===correctanswer&&(""==(char=$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]').val())||char!=data.character)&&(correctanswer=!1)})),callback(correctanswer)},end:function(){var self=this;$(".readaloud_nextbutton").prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){$(".readaloud_nextbutton").prop("disabled",!1),self.quizhelper.showqreview?self.show_item_review():self.next_question()}),2e3)},start:function(){$("#"+this.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!0),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,$("#"+this.itemdata.uniqueid+"_container .lgapfill_listen_cont").show(),$("#"+this.itemdata.uniqueid+"_container .question").show(),$("#"+this.itemdata.uniqueid+"_container .lgapfill_game").show(),$("#"+this.itemdata.uniqueid+"_container .lgapfill_start_btn").hide(),$("#"+this.itemdata.uniqueid+"_container .lgapfill_mainmenu").hide(),$("#"+this.itemdata.uniqueid+"_container .lgapfill_controls").show(),this.nextPrompt()},nextPrompt:function(){$("#"+this.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!1),this.updateProgressDots(),this.nextReply(),null!==this.items[this.game.pointer].audio&&$("#"+this.itemdata.uniqueid+"_container .lgapfill_listen_btn").trigger("click")},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");$("#"+self.itemdata.uniqueid+"_container .lgapfill_title").html(progress)},nextReply:function(){var self=this,code="<div class='lgapfill_reply lgapfill_reply_"+self.game.pointer+" text-center' style='display:none;'>";code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){"input"===data.type?code+="<input class='single-character' type='text' autocomplete='off' name='filltext"+index+"' maxlength='1' data-index='"+index+"'>":"mtext"===data.type?code+="<input class='single-character-mtext' autocomplete='off' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),code+=" <i data-idx='"+self.game.pointer+"' class='lgapfill_feedback'></i></div>",""!==self.items[self.game.pointer].definition&&(code+="<div class='definition-container'>",code+="<div class='definition'>"+self.items[self.game.pointer].definition+"</div>",code+="</div>"),code+="</div>",$("#"+self.itemdata.uniqueid+"_container .question").append(code);var newreply=$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer);anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),$("#"+self.itemdata.uniqueid+"_container .lgapfill_ctrl-btn").prop("disabled",!1);var inputElements=[...document.querySelectorAll("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" input.single-character")];(self.formReady(inputElements),$("#"+self.itemdata.uniqueid+"_container .lgapfill_reply_"+self.game.pointer+" input.single-character:first").focus(),self.itemdata.timelimit>0)&&($("#"+self.itemdata.uniqueid+"_container .progress-container").show(),$("#"+self.itemdata.uniqueid+"_container .progress-container i").show(),$("#"+self.itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){$("#"+self.itemdata.uniqueid+"_container .lgapfill_check_btn").trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))})))},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))},formReady:function(inputElements){inputElements.forEach((function(ele,index){ele.addEventListener("keydown",(function(e){8===e.keyCode&&""===e.target.value&&inputElements[Math.max(0,index-1)].focus()})),ele.addEventListener("input",(function(e){const[first,...rest]=e.target.value;e.target.value=null!=first?first:"";const lastInputBox=index===inputElements.length-1;void 0!==first&&!lastInputBox&&(inputElements[index+1].focus(),inputElements[index+1].value=rest.join(""),inputElements[index+1].dispatchEvent(new Event("input")))}))}))}}}));

//# sourceMappingURL=listeninggapfill.min.js.map