define(["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/pollyhelper","mod_readaloud/cloudpoodllloader","mod_readaloud/ttrecorder","mod_readaloud/animatecss","mod_readaloud/progresstimer","core/templates"],(function($,log,ajax,def,polly,cloudpoodll,ttrecorder,anim,progresstimer,templates){return log.debug("Readaloud speaking gap fill: initialising"),{ttrec:null,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var self=this,theCallback=function(message){switch(message.type){case"recording":break;case"speech":log.debug("Speech at speaking gap fill -");var words=self.items[self.game.pointer].words,maskedwords=[];Object.keys(words).forEach((function(key){maskedwords.push(words[key])})),self.getComparison(maskedwords.join(" "),message.capturedspeech,self.items[self.game.pointer].phonetic,(function(comparison){self.gotComparison(comparison,message)}))}};if(quizhelper.use_ttrecorder()){var opts={};opts.uniqueid=itemdata.uniqueid,opts.callback=theCallback,opts.stt_guided=quizhelper.is_stt_guided(),opts.wwwroot=quizhelper.is_stt_guided(),self.ttrec=ttrecorder.clone(),self.ttrec.init(opts)}else cloudpoodll.init("readaloud-recorder-listenrepeat-"+itemdata.id,theCallback);self.itemdata=itemdata,log.debug("itemdata"),log.debug(itemdata),self.quizhelper=quizhelper,self.index=index;var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),self.register_events(),self.setvoice(),self.getItems()},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=this.items.length,stepdata.correctitems=this.items.filter((function(e){return e.correct})).length,stepdata.grade=Math.round(stepdata.correctitems/stepdata.totalitems*100),this.quizhelper.do_next(stepdata)},show_item_review:function(){var review_data={};review_data.items=this.items,review_data.totalitems=this.items.length,review_data.correctitems=this.items.filter((function(e){return e.correct})).length;var listencont=$("#"+this.itemdata.uniqueid+"_container .sgapfill_listen_cont"),qbox=$("#"+this.itemdata.uniqueid+"_container .question"),recorderbox=$("#"+this.itemdata.uniqueid+"_container .sgapfill_speakbtncontainer"),gamebox=$("#"+this.itemdata.uniqueid+"_container .sgapfill_game"),controlsbox=$("#"+this.itemdata.uniqueid+"_container .sgapfill_controls"),resultsbox=$("#"+this.itemdata.uniqueid+"_container .sgapfill_resultscontainer");templates.render("mod_readaloud/listitemresults",review_data).then((function(html,js){resultsbox.html(html),resultsbox.show(),gamebox.hide(),controlsbox.hide(),listencont.hide(),qbox.hide(),recorderbox.hide(),templates.runTemplateJS(js)}))},register_events:function(){var self=this;$("#"+self.itemdata.uniqueid+"_container .readaloud_nextbutton").on("click",(function(e){self.next_question()})),$("#"+self.itemdata.uniqueid+"_container .sgapfill_start_btn").on("click",(function(){self.start()}));var audioplayerbtn=$("#"+self.itemdata.uniqueid+"_container .sgapfill_listen_btn");self.itemdata.readsentence&&audioplayerbtn.on("click",(function(){var theaudio=self.items[self.game.pointer].audio;if(!theaudio.paused)return theaudio.pause(),theaudio.currentTime=0,$(audioplayerbtn).children(".fa").removeClass("fa-stop"),void $(audioplayerbtn).children(".fa").addClass("fa-volume-up");theaudio.addEventListener("ended",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-stop"),$(audioplayerbtn).children(".fa").addClass("fa-volume-up")})),theaudio.addEventListener("play",(function(){$(audioplayerbtn).children(".fa").removeClass("fa-volume-up"),$(audioplayerbtn).children(".fa").addClass("fa-stop")})),theaudio.load(),theaudio.play()})),$("#"+self.itemdata.uniqueid+"_container .sgapfill_skip_btn").on("click",(function(){$("#"+self.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0),$("#"+self.itemdata.uniqueid+"_container .sgapfill_speech.sgapfill_teacher_left").text(self.items[self.game.pointer].prompt+""),$("#"+self.itemdata.uniqueid+"_container .sgapfill_targetWord").each((function(){var realidx=$(this).data("realidx"),sgapfill_targetWord=self.items[self.game.pointer].sgapfill_targetWords[realidx];$(this).val(sgapfill_targetWord)})),self.stopTimer(self.items[self.game.pointer].timer),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.game.pointer<self.items.length-1?setTimeout((function(){$(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3):self.end()}))},game:{pointer:0},usevoice:"",setvoice:function(){this.usevoice=this.itemdata.usevoice,this.voiceoption=this.itemdata.voiceoption},getItems:function(){var self=this,text_items=self.itemdata.sentences;self.items=text_items.map((function(target){return{target:target.sentence,prompt:target.prompt,parsedstring:target.parsedstring,displayprompt:target.displayprompt,definition:target.definition,phonetic:target.phonetic,words:target.words,typed:"",timer:[],answered:!1,correct:!1,audio:null}})).filter((function(e){return""!==e.target})),self.itemdata.readsentence?$.each(self.items,(function(index,item){polly.fetch_polly_url(item.prompt,self.voiceoption,self.usevoice).then((function(audiourl){item.audio=new Audio,item.audio.src=audiourl,0===self.items.filter((function(e){return null===e.audio})).length&&self.appReady()}))})):self.appReady()},appReady:function(){$("#"+this.itemdata.uniqueid+"_container .sgapfill_not_loaded").hide(),$("#"+this.itemdata.uniqueid+"_container .sgapfill_loaded").show(),this.itemdata.hidestartpage?this.start():$("#"+this.itemdata.uniqueid+"_container .sgapfill_start_btn").prop("disabled",!1)},gotComparison:function(comparison,typed){log.debug("sgapfill comparison");var self=this,countdownStarted=!1,feedback=$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer+" .dictate_feedback[data-idx='"+self.game.pointer+"']");$("#"+self.itemdata.uniqueid+"_container .sgapfill_targetWord").removeClass("sgapfill_correct sgapfill_incorrect"),$("#"+self.itemdata.uniqueid+"_container .sgapfill_feedback").removeClass("fa fa-check fa-times");var allCorrect=0==comparison.filter((function(e){return!e.matched})).length;if(log.debug("allcorrect="+allCorrect),allCorrect&&comparison&&comparison.length>0)self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');"input"===data.type&&characterinput.val(data.character)})),feedback.removeClass("fa fa-times"),feedback.addClass("fa fa-check"),log.debug("applying correct class to input boxes"),$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer+" input").addClass("ml_gapfill_char_correct"),self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!0,self.items[self.game.pointer].typed=typed,$("#"+self.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0),self.stopTimer(self.items[self.game.pointer].timer),self.game.pointer<self.items.length-1&&!countdownStarted?(countdownStarted=!0,log.debug("moving to next prompt B"),setTimeout((function(){$(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3)):(self.updateProgressDots(),self.end());else{feedback.removeClass("fa fa-check"),feedback.addClass("fa fa-times"),comparison.forEach((function(obj){var words=self.items[self.game.pointer].words;Object.keys(words).forEach((function(key){words[key]==obj.word&&(obj.matched?self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val(data.character)})):self.items[self.game.pointer].parsedstring.forEach((function(data,index){var characterinput=$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer+' input.single-character[data-index="'+index+'"]');data.index==key&&"input"===data.type&&characterinput.val("")})))}))}));var thereply=$("#"+self.itemdata.uniqueid+"_container .sgapfill_reply_"+self.game.pointer);anim.do_animate(thereply,"shakeX animate__faster").then((function(){$("#"+self.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!1)})),$("#"+self.itemdata.uniqueid+"_container .sgapfill_targetWord.sgapfill_correct").each((function(){var realidx=$(this).data("realidx"),sgapfill_targetWord=self.items[self.game.pointer].sgapfill_targetWords[realidx];$(this).val(sgapfill_targetWord)}));var timelimit_progressbar=$("#"+self.itemdata.uniqueid+"_container .progress-container .progress-bar");self.itemdata.allowretry&&!timelimit_progressbar.hasClass("progress-bar-complete")||(self.items[self.game.pointer].answered=!0,self.items[self.game.pointer].correct=!1,self.items[self.game.pointer].typed=typed,$("#"+self.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0),self.stopTimer(self.items[self.game.pointer].timer),countdownStarted||(self.game.pointer<self.items.length-1?(log.debug("moving to next prompt A"),countdownStarted=!0,setTimeout((function(){$(".sgapfill_reply_"+self.game.pointer).hide(),self.game.pointer++,self.nextPrompt()}),2e3)):(self.updateProgressDots(),self.end())))}},getComparison:function(passage,transcript,phonetic,callback){$(".sgapfill_ctrl-btn").prop("disabled",!0),this.quizhelper.comparePassageToTranscript(passage,transcript,phonetic,this.itemdata.language).then((function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)}))},end:function(){var self=this;$(".readaloud_nextbutton").prop("disabled",!0),self.updateProgressDots(),setTimeout((function(){$(".readaloud_nextbutton").prop("disabled",!1),self.quizhelper.showitemreview?self.show_item_review():self.next_question()}),2e3)},start:function(){$("#"+this.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!0),$("#"+this.itemdata.uniqueid+"_container .sgapfill_speakbtncontainer").show(),this.items.forEach((function(item){item.spoken="",item.answered=!1,item.correct=!1})),this.game.pointer=0,$("#"+this.itemdata.uniqueid+"_container .question").show(),this.itemdata.readsentence&&$("#"+this.itemdata.uniqueid+"_container .sgapfill_listen_cont").show(),$("#"+this.itemdata.uniqueid+"_container .sgapfill_start_btn").hide(),$("#"+this.itemdata.uniqueid+"_container .sgapfill_mainmenu").hide(),$("#"+this.itemdata.uniqueid+"_container .sgapfill_controls").show(),this.nextPrompt()},updateProgressDots:function(){var color,self=this,progress=self.items.map((function(item,idx){return color="gray",self.items[idx].answered&&self.items[idx].correct?color="green":self.items[idx].answered&&!self.items[idx].correct&&(color="red"),"<i style='color:"+color+"' class='fa fa-circle'></i>"})).join(" ");$("#"+self.itemdata.uniqueid+"_container .sgapfill_title").html(progress)},nextPrompt:function(){$(".sgapfill_ctrl-btn").prop("disabled",!1),this.updateProgressDots();var newprompt=$(".sgapfill_prompt_"+this.game.pointer);anim.do_animate(newprompt,"zoomIn animate__faster","in").then((function(){})),this.nextReply()},nextReply:function(){var self=this,code="<div class='sgapfill_reply sgapfill_reply_"+self.game.pointer+" text-center' style='display:none;'>";code+="<div class='form-container'>",self.items[self.game.pointer].parsedstring.forEach((function(data,index){"input"===data.type?code+="<input class='single-character' autocomplete='off' type='text' name='filltext"+index+"' maxlength='1' data-index='"+index+"' readonly>":"mtext"===data.type?code+="<input class='single-character-mtext' type='text' name='readonly"+index+"' maxlength='1' value='"+data.character+"' readonly>":code+=data.character})),code+=" <i data-idx='"+self.game.pointer+"' class='dictate_feedback'></i></div>",code+="<div class='definition-container'>",code+="<div class='definition'>"+self.items[self.game.pointer].definition+"</div>",code+="</div>",$("#"+self.itemdata.uniqueid+"_container .question").append(code);var newreply=$(".sgapfill_reply_"+self.game.pointer);(anim.do_animate(newreply,"zoomIn animate__faster","in").then((function(){})),$("#"+self.itemdata.uniqueid+"_container .sgapfill_ctrl-btn").prop("disabled",!1),self.itemdata.timelimit>0)&&($("#"+self.itemdata.uniqueid+"_container .progress-container").show(),$("#"+self.itemdata.uniqueid+"_container .progress-container i").show(),$("#"+self.itemdata.uniqueid+"_container .progress-container #progresstimer").progressTimer({height:"5px",timeLimit:self.itemdata.timelimit,onFinish:function(){$("#"+self.itemdata.uniqueid+"_container .sgapfill_skip_btn").trigger("click")}}).each((function(){self.items[self.game.pointer].timer.push($(this).attr("timer"))})));self.quizhelper.mobile_user()||setTimeout((function(){$("#"+self.itemdata.uniqueid+"_container .sgapfill_listen_btn").trigger("click")}),1e3);var target=self.items[self.game.pointer].target;self.quizhelper.use_ttrecorder()&&(self.ttrec.currentPrompt=target)},stopTimer:function(timers){timers.length&&timers.forEach((function(timer){clearInterval(timer)}))}}}));

//# sourceMappingURL=speakinggapfill.min.js.map