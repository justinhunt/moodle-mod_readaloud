define(["jquery","core/log","mod_readaloud/definitions","core/templates","core/ajax","mod_readaloud/pollyhelper","mod_readaloud/multichoice","mod_readaloud/multiaudio","mod_readaloud/page","mod_readaloud/shortanswer","mod_readaloud/listeninggapfill","mod_readaloud/typinggapfill","mod_readaloud/speakinggapfill","mod_readaloud/freespeaking","mod_readaloud/freewriting"],(function($,log,def,templates,Ajax,polly,multichoice,multiaudio,page,shortanswer,listeninggapfill,typinggapfill,speakinggapfill,freespeaking,freewriting){return log.debug("Readaloud Quiz helper: initialising"),{spliton_regexp:new RegExp(/([!"# ¡¿$%&()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),nopunc_regexp:new RegExp(/[!"#¡¿$%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~]/,"g"),nonspaces_regexp:new RegExp(/[^ ]/,"g"),autoplaydelay:800,controls:{},submitbuttonclass:"mod_readaloud_quizsubmitbutton",stepresults:[],init:function(activitydata,cmid,attemptid){log.debug(activitydata),this.quizdata=activitydata.quizdata,this.region=activitydata.region,this.ttslanguage=activitydata.ttslanguage,this.controls.quizcontainer=$("."+activitydata.quizcontainer),this.controls.quizitemscontainer=$("."+activitydata.quizitemscontainer),this.controls.quizresultscontainer=$("."+activitydata.quizresultscontainer),this.attemptid=attemptid,this.courseurl=activitydata.courseurl,this.cmid=cmid,this.reattempturl=decodeURIComponent(activitydata.reattempturl).replace(/&amp;/g,"&"),this.activityurl=decodeURIComponent(activitydata.activityurl).replace(/&amp;/g,"&"),this.backtocourse=activitydata.backtocourse,this.stt_guided=activitydata.stt_guided,this.wwwroot=activitydata.wwwroot,this.useanimatecss=activitydata.useanimatecss,this.showqreview=activitydata.showqreview,polly.init(this.quizdata.token,this.quizdata.region,this.quizdata.owner),this.prepare_html(),this.init_questions(this.quizdata),this.register_events(),this.start_quiz()},on_complete:function(){},prepare_html:function(){this.controls.quizfinished=$("#mod_readaloud_quiz_finished")},init_questions:function(quizdata){var dd=this;$.each(quizdata,(function(index,item){switch(item.type){case def.qtype_multichoice:multichoice.clone().init(index,item,dd);break;case def.qtype_multiaudio:multiaudio.clone().init(index,item,dd);break;case def.qtype_page:page.clone().init(index,item,dd);break;case def.qtype_shortanswer:shortanswer.clone().init(index,item,dd);break;case def.qtype_listeninggapfill:listeninggapfill.clone().init(index,item,dd);break;case def.qtype_typinggapfill:typinggapfill.clone().init(index,item,dd);break;case def.qtype_speakinggapfill:speakinggapfill.clone().init(index,item,dd);break;case def.qtype_freespeaking:freespeaking.clone().init(index,item,dd);break;case def.qtype_freewriting:freewriting.clone().init(index,item,dd)}})),$("audio.mod_readaloud_itemttsaudio").each((function(){var that=this;polly.fetch_polly_url($(this).data("text"),$(this).data("ttsoption"),$(this).data("voice")).then((function(audiourl){$(that).attr("src",audiourl)}))}))},register_events:function(){$("."+this.submitbuttonclass).on("click",(function(){}))},render_quiz_progress:function(current,total){for(var array=[],i=0;i<total;i++)array.push(i);if(total<6){var html="<div class='readaloud_quiz_progress_line' style='"+(linestyles="width: "+(100-100/(slice=array.slice(0,5)).length)+"%; margin-left: auto; margin-right: auto")+"'></div>";slice.forEach((function(i){html+="<div class='readaloud_quiz_progress_item "+(i===current?"readaloud_quiz_progress_item_current":"")+" "+(i<current?"readaloud_quiz_progress_item_completed":"")+"'>"+(i+1)+"</div>"}))}else{if(current>total-6)var slice=array.slice(total-5,total-1);else slice=array.slice(current,current+4);if(0==current)var linestyles="width: 80%; margin-left: auto; margin-right: auto";else linestyles="width: "+(100-100/(2*slice.length))+"%; margin-left: 0";html="<div class='readaloud_quiz_progress_line' style='"+linestyles+"'></div>";slice.forEach((function(i){html+="<div class='readaloud_quiz_progress_item "+(i===current?"readaloud_quiz_progress_item_current":"")+" "+(i<current?"readaloud_quiz_progress_item_completed":"")+"'>"+(i+1)+"</div>"})),html+="<div class='readaloud_quiz_progress_finalitem'>"+total+"</div>"}html+="",$(".readaloud_quiz_progress").html(html)},do_next:function(stepdata){var dd=this,currentquizdataindex=stepdata.index,currentitem=this.quizdata[currentquizdataindex];if(!0!==currentitem.preview){dd.report_step_grade(stepdata);var theoldquestion=$("#"+currentitem.uniqueid+"_container");if(!(dd.quizdata.length>currentquizdataindex+1))return dd.on_complete(),$(".readaloud_nextbutton").prop("disabled",!0),void Ajax.call([{methodname:"mod_readaloud_fetch_quiz_results",args:{cmid:dd.cmid},async:!1}])[0].then((function(jsonresults){var results=JSON.parse(jsonresults);log.debug(results),templates.render("mod_readaloud/quizfinished",results).then((function(html,js){dd.controls.quizresultscontainer.html(html),dd.controls.quizresultscontainer.show(),dd.controls.quizitemscontainer.hide(),templates.runTemplateJS(js)}))}));var nextindex=currentquizdataindex+1,nextitem=this.quizdata[nextindex];switch(theoldquestion.hide(),$("#"+nextitem.uniqueid+"_container").show(),nextitem.type){case def.qtype_speechcards:case def.qtype_dictation:case def.qtype_dictationchat:case def.qtype_multichoice:case def.qtype_multiaudio:case def.qtype_listenrepeat:case def.qtype_smartframe:case def.qtype_shortanswer:case def.qtype_spacegame:case def.qtype_fluency:case def.qtype_freespeaking:case def.qtype_freewriting:case def.qtype_passagereading:case def.qtype_buttonquiz:case def.qtype_conversation:case def.qtype_compquiz:}var ttsquestionplayer=$("#"+nextitem.uniqueid+"_container audio.mod_readaloud_itemttsaudio");if("1"==ttsquestionplayer.data("autoplay")){setTimeout((function(){ttsquestionplayer[0].play()}),this.autoplaydelay)}dd.render_quiz_progress(stepdata.index+1,this.quizdata.length),theoldquestion.remove()}},report_step_grade:function(stepdata){this.stepresults.push(stepdata);var ret=Ajax.call([{methodname:"mod_readaloud_report_quizstep_grade",args:{cmid:this.cmid,step:JSON.stringify(stepdata)},async:!1}])[0];log.debug("report_step_grade success: "+ret)},start_quiz:function(){if(null!=this.quizdata&&0!=this.quizdata.length){$("#"+this.quizdata[0].uniqueid+"_container").show();var ttsquestionplayer=$("#"+this.quizdata[0].uniqueid+"_container audio.mod_readaloud_itemttsaudio");if("1"==ttsquestionplayer.data("autoplay")){setTimeout((function(){ttsquestionplayer[0].play()}),this.autoplaydelay)}this.render_quiz_progress(0,this.quizdata.length)}},onSubmit:function(){alert("quiz submitted. Override this")},mobile_user:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},chrome_user:function(){return!!/Chrome/i.test(navigator.userAgent)},use_ttrecorder:function(){return!0},is_stt_guided:function(){return this.stt_guided},count_words:function(transcript){return transcript.trim().split(/\s+/).filter((function(word){return word.length>0})).length},similarity:function(s1,s2){var longer=s1=s1.replace(/\s+/g,""),shorter=s2=s2.replace(/\s+/g,"");s1.length<s2.length&&(longer=s2,shorter=s1);var longerLength=longer.length;return 0===longerLength?100:(longerLength-this.editDistance(longer,shorter))/parseFloat(longerLength)*100},editDistance:function(s1,s2){s1=s1.toLowerCase(),s2=s2.toLowerCase();for(var costs=[],i=0;i<=s1.length;i++){for(var lastValue=i,j=0;j<=s2.length;j++)if(0===i)costs[j]=j;else if(j>0){var newValue=costs[j-1];s1.charAt(i-1)!==s2.charAt(j-1)&&(newValue=Math.min(Math.min(newValue,lastValue),costs[j])+1),costs[j-1]=lastValue,lastValue=newValue}i>0&&(costs[s2.length]=lastValue)}return costs[s2.length]},cleanText:function(text){return text.toLowerCase().replace(this.nopunc_regexp,"").replace(/\s+/g," ").trim()},checkByPhonetic:function(passage,transcript,passagephonetic,language){return Ajax.call([{methodname:"mod_readaloud_check_by_phonetic",args:{spoken:transcript,correct:passage,language:language,phonetic:passagephonetic,region:this.region,cmid:this.cmid},async:!1}])[0]},comparePassageToTranscript:function(passage,transcript,passagephonetic,language){return Ajax.call([{methodname:"mod_readaloud_compare_passage_to_transcript",args:{passage:passage,transcript:transcript,passagephonetic:"",language:language,cmid:this.cmid},async:!1}])[0]},evaluateTranscript:function(transcript,itemid){return Ajax.call([{methodname:"mod_readaloud_evaluate_transcript",args:{transcript:transcript,itemid:itemid,cmid:this.cmid},async:!1}])[0]}}}));

//# sourceMappingURL=quizhelper.min.js.map