define("mod_readaloud/practice",["jquery","core/log","core/ajax","mod_readaloud/definitions","mod_readaloud/ttrecorder"],(function($,log,ajax,def,ttrecorder){return log.debug("Readaloud Practice: initialising"),{activated:!1,audiourl:"",currentSentence:"",currentPhonetic:"",language:"en-US",breaks:[],currentbreak:0,controls:{},results:[],phonetics:[],cmid:0,ttr:{},init:function(props){var self=this;self.cmid=props.cmid,self.mak=props.modelaudiokaraoke,self.audiourl=self.mak.fetch_audio_url(),self.set_breaks(self.mak.breaks),self.language=props.language,self.region=props.region,self.phonetics=props.phonetics,self.stt_guided=props.stt_guided,self.shadow=!1,self.ttr={};var opts={uniqueid:"readaloud_ttrecorder"};opts.stt_guided=self.stt_guided,opts.callback=function(message){switch(log.debug("Readaloud Practice: ttrecorder callback",message),log.debug(message),message.type){case"recordingstarted":self.controls.shadowplaycheckbox.is(":checked")?(self.shadow=!0,log.debug("shadow is true"),self.controls.playbutton.trigger("click")):(log.debug("shadow is false"),self.shadow=!1),self.controls.playselfbutton.hide();break;case"recordingstopped":!0===self.shadow&&self.controls.hiddenplayer[0].pause(),(self.stt_guided||!1===self.ttr.usebrowserrec)&&self.controls.playselfbutton.show();break;case"speech":self.getComparison(self.cmid,self.currentSentence,message.capturedspeech,self.currentPhonetic,(function(comparison){self.gotComparison(comparison,message)}))}},opts.shadow=!1,self.ttr=ttrecorder.clone(),self.ttr.init(opts),self.prepare_controls(),self.register_events(),self.move_break(0)},prepare_controls:function(){this.controls.container=$("#"+def.practicecontainer),this.controls.hiddenplayer=$("#mod_readaloud_practice_hiddenplayer"),this.controls.hiddenselfplayer=$("#mod_readaloud_practice_hiddenselfplayer"),this.controls.playbutton=$("#mod_readaloud_practice_play"),this.controls.shadowplaycheckbox=$("#mod_readaloud_practice_shadow"),this.controls.skipforwardbutton=$("#mod_readaloud_practice_skipforward"),this.controls.skipbackbutton=$("#mod_readaloud_practice_skipback"),this.controls.finishedbutton=$("#mod_readaloud_practice_finished"),this.controls.playselfbutton=$("#mod_readaloud_practice_playself"),this.controls.hiddenplayer.attr("src",this.audiourl)},set_breaks:function(breaks){this.breaks=breaks,this.sort_breaks(),this.add_info_to_breaks()},sort_breaks:function(){this.breaks.sort((function(a,b){return a.audiotime-b.audiotime}))},add_info_to_breaks:function(){for(var lastbreakaudioend=0,lastbreakwordnumber=0,i=0;i<this.breaks.length;i++){this.breaks[i].breaknumber=i+1,this.breaks[i].audiostarttime=lastbreakaudioend;for(var thesentence="",thewordnumber=lastbreakwordnumber+1;thewordnumber<=this.breaks[i].wordnumber;thewordnumber++)thesentence+=$("#"+def.spaceclass+"_"+thewordnumber).text(),thesentence+=$("#"+def.wordclass+"_"+thewordnumber).text();this.breaks[i].sentence=thesentence,lastbreakaudioend=this.breaks[i].audiotime,lastbreakwordnumber=this.breaks[i].wordnumber}},pause_audio:function(){this.controls.hiddenplayer[0].pause()},play_audio:function(){this.controls.hiddenplayer[0].play()},get_audio_time:function(){return this.controls.hiddenplayer[0].currentTime},set_audio_time:function(newtime){this.controls.hiddenplayer[0].currentTime=newtime},fetch_audio_url:function(){return this.controls.hiddenplayer.attr("src")},move_break:function(increment){if(!(this.currentbreak+increment<0||this.currentbreak+increment>=this.breaks.length)){this.currentbreak+=increment;var thebreak=this.breaks[this.currentbreak],prevbreak=this.currentbreak-1>0?this.breaks[this.currentbreak-1]:{wordnumber:0,audiotime:0};if(""!==thebreak.sentence.trim()){var thesentence=thebreak.sentence.trim();if(this.currentSentence=thesentence,this.ttr.usebrowserrec||(this.ttr.currentPrompt=thesentence),this.phonetics.length>thebreak.wordnumber-1){var startpos=prevbreak.wordnumber;startpos<0&&(startpos=0);var endpos=thebreak.wordnumber;this.currentPhonetic=this.phonetics.slice(startpos,endpos).join(" ")}else this.currentPhonetic="";this.currentbreak===this.breaks[this.breaks.length-1]?(this.controls.finishedbutton.show(),this.controls.skipforwardbutton.hide(),this.on_complete()):(this.controls.finishedbutton.hide(),this.controls.skipforwardbutton.show()),this.controls.playselfbutton.hide(),this.pause_audio(),$("#mod_readaloud_practice_target_phrase").html(thesentence.split(/ /).map((function(e,i){return'<div class="mod_readaloud_practice_target_word" data-index="'+i+'">'+e+"</div>"})))}}},on_complete:function(){},register_events:function(){var self=this,aplayer=self.controls.hiddenplayer[0];self.controls.playbutton.on("click",(function(e){aplayer.paused?(aplayer.currentTime=self.breaks[self.currentbreak].audiostarttime,aplayer.play()):aplayer.pause()})),self.controls.playselfbutton.on("click",(function(e){self.controls.hiddenselfplayer[0].paused?(self.controls.hiddenselfplayer.attr("src",self.ttr.audio.dataURI),self.controls.hiddenselfplayer[0].play()):self.controls.hiddenselfplayer[0].pause()})),self.controls.shadowplaycheckbox.on("change",(function(e){self.ttr.shadow=$(this).is(":checked")})),self.controls.skipforwardbutton.on("click",(function(e){self.move_break(1)})),self.controls.skipbackbutton.on("click",(function(e){self.move_break(-1)})),self.controls.finishedbutton.on("click",(function(){aplayer.currentTime=0})),aplayer.ontimeupdate=function(){var currentbreak=self.breaks[self.currentbreak];aplayer.currentTime>=currentbreak.audiotime&&aplayer.pause()}},spliton:new RegExp(/([!"# $%&'()。「」、*+,-.\/:;<=>?@[\]^_`{|}~])/,"g"),gotComparison:function(comparison,typed){if(comparison){var thisClass,self=this,wordsmatched=0;$(".mod_readaloud_practice_target_word").removeClass("mod_readaloud_practice_target_word_correct mod_readaloud_practice_target_word_incorrect"),comparison.forEach((function(word,idx){word.matched?(thisClass="mod_readaloud_practice_target_word_correct",wordsmatched++):thisClass="mod_readaloud_practice_target_word_incorrect",$(".mod_readaloud_practice_target_word[data-index='"+idx+"']").addClass(thisClass),comparison.length==wordsmatched&&setTimeout((function(){self.controls.skipbutton.trigger("click")}),600)}))}},getComparison:function(cmid,passage,transcript,passagephonetic,callback){ajax.call([{methodname:"mod_readaloud_compare_passage_to_transcript",args:{cmid:cmid,passage:passage,transcript:transcript,passagephonetic:passagephonetic,language:this.language},done:function(ajaxresult){var payloadobject=JSON.parse(ajaxresult);callback(payloadobject||!1)},fail:function(err){log.debug(err)}}])},mobile_user:function(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},chrome_user:function(){return!!/Chrome/i.test(navigator.userAgent)}}}));

//# sourceMappingURL=practice.min.js.map