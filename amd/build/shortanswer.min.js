define(["jquery","core/log","mod_readaloud/definitions","mod_readaloud/pollyhelper","mod_readaloud/cloudpoodllloader","mod_readaloud/ttrecorder","mod_readaloud/animatecss"],(function($,log,def,polly,cloudpoodll,ttrecorder,anim){return log.debug("Readaloud ShortAnswer: initialising"),{ttrec:null,passmark:90,clone:function(){return $.extend(!0,{},this)},init:function(index,itemdata,quizhelper){var animopts={};animopts.useanimatecss=quizhelper.useanimatecss,anim.init(animopts),this.register_events(index,itemdata,quizhelper),this.init_components(index,itemdata,quizhelper)},next_question:function(percent){var stepdata={};stepdata.index=this.index,stepdata.hasgrade=!0,stepdata.totalitems=1,stepdata.correctitems=percent>0?1:0,stepdata.grade=percent,this.quizhelper.do_next(stepdata)},prepare_audio:function(itemdata){$.each(itemdata.sentences,(function(index,sentence){polly.fetch_polly_url(sentence.sentence,itemdata.voiceoption,itemdata.usevoice).then((function(audiourl){$("#"+itemdata.uniqueid+"_option"+(index+1)).attr("data-src",audiourl)}))}))},register_events:function(index,itemdata,quizhelper){var self=this;self.index=index,self.quizhelper=quizhelper,$("#"+itemdata.uniqueid+"_container .readaloud_nextbutton").on("click",(function(e){self.next_question(0)})),$("#"+itemdata.uniqueid+"_container ."+itemdata.uniqueid+"_option").on("click",(function(e){$("."+itemdata.uniqueid+"_option").prop("disabled",!0),$("."+itemdata.uniqueid+"_fb").html("<i style='color:red;' class='fa fa-times'></i>"),$("."+itemdata.uniqueid+"_option"+itemdata.correctanswer+"_fb").html("<i style='color:green;' class='fa fa-check'></i>");var percent=$("input[name="+itemdata.uniqueid+"_options]:checked").data("index")==itemdata.correctanswer?100:0;$(".readaloud_nextbutton").prop("disabled",!0),setTimeout((function(){$(".readaloud_nextbutton").prop("disabled",!1),self.next_question(percent)}),2e3)}))},init_components:function(index,itemdata,quizhelper){var app=this,sentences=itemdata.sentences;log.debug("initcomponents_shortanswer"),log.debug(sentences);for(var i=0;i<sentences.length;i++)sentences[i].originalsentence=sentences[i].sentence,sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);var opts={};opts.uniqueid=itemdata.uniqueid,log.debug("sa uniqueid:"+itemdata.uniqueid),opts.callback=async function(message){switch(message.type){case"recording":break;case"speech":log.debug("speech at shortanswer");var speechtext=message.capturedspeech,cleanspeechtext=quizhelper.cleanText(speechtext),spoken=cleanspeechtext;log.debug("speechtext:",speechtext),log.debug("cleanspeechtext:",spoken);for(var matched=!1,percent=0,x=0;x<sentences.length;x++)if(""!==sentences[x].sentence){var similar=quizhelper.similarity(spoken,sentences[x].sentence);if(log.debug("JS similarity: "+spoken+":"+sentences[x].sentence+":"+similar),similar>=app.passmark||app.spokenIsCorrect(quizhelper,cleanspeechtext,sentences[x].sentence)){percent=app.process_accepted_response(itemdata,x),matched=!0;break}}if(!matched)for(x=0;x<sentences.length;x++){for(var ajaxresult=await quizhelper.comparePassageToTranscript(sentences[x].sentence,spoken,sentences[x].phonetic,itemdata.language),result=JSON.parse(ajaxresult),haserror=!1,i=0;i<result.length;i++)if(!1===result[i].matched){haserror=!0;break}if(!haserror){percent=app.process_accepted_response(itemdata,x),matched=!0;break}}if(matched)return $(".readaloud_nextbutton").prop("disabled",!0),void setTimeout((function(){$(".readaloud_nextbutton").prop("disabled",!1),app.next_question(percent)}),2e3);var theanswer=$("#"+itemdata.uniqueid+"_correctanswer");anim.do_animate(theanswer,"rubberBand animate__faster").then((function(){}))}},opts.stt_guided=quizhelper.is_stt_guided(),app.ttrec=ttrecorder.clone(),app.ttrec.init(opts);var allsentences="";for(i=0;i<sentences.length;i++)allsentences+=sentences[i].sentence+" ",sentences[i].originalsentence=sentences[i].sentence,sentences[i].sentence=quizhelper.cleanText(sentences[i].sentence);app.ttrec.currentPrompt=allsentences},spokenIsCorrect:function(quizhelper,phraseheard,currentphrase){return(phraseheard=quizhelper.cleanText(phraseheard))===(currentphrase=quizhelper.cleanText(currentphrase))},process_accepted_response:function(itemdata,sentenceindex){var percent=sentenceindex>=0?100:0;if(percent>0){if(0===parseInt(itemdata.show_text))for(var i=0;i<itemdata.sentences.length;i++){$("#"+itemdata.uniqueid+"_option"+(i+1));$("#"+itemdata.uniqueid+"_option"+(i+1)+" .readaloud_sentence").text(itemdata.sentences[i].sentence)}var answerdisplay=$("#"+itemdata.uniqueid+"_correctanswer");answerdisplay.text(itemdata.sentences[sentenceindex].originalsentence),answerdisplay.addClass("readaloud_success")}return percent}}}));

//# sourceMappingURL=shortanswer.min.js.map